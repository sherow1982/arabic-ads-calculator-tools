<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ - Ù…Ø®ØªØµØ± Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</title>
    <meta name="description" content="Ù…Ø®ØªØµØ± Ø±ÙˆØ§Ø¨Ø· Ø¹Ø§Ù„Ù…ÙŠ - ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - Ø¹Ø±Ø¨ÙŠØŒ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØŒ Ø±Ù…ÙˆØ²ØŒ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">
    
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #db2777 100%);
            margin: 0; padding: 0; display: flex;
            justify-content: center; align-items: center;
            min-height: 100vh; color: white; text-align: center;
        }
        
        .container {
            max-width: 700px; padding: 2.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px; backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; border-top: 4px solid white;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        h1 {
            font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .status {
            font-size: 1.3rem; margin: 1.5rem 0; opacity: 0.95; line-height: 1.5;
        }
        
        .url-display {
            background: rgba(255, 255, 255, 0.15); padding: 1.5rem;
            border-radius: 15px; margin: 2rem 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .url-label { font-size: 1rem; opacity: 0.8; margin-bottom: 0.5rem; }
        .url-value { 
            font-size: 1.1rem; font-weight: 600; word-break: break-all; 
            color: #fbbf24; line-height: 1.4; max-height: 150px; overflow-y: auto;
        }
        
        .manual-button {
            display: inline-block; background: rgba(255, 255, 255, 0.9); color: #4f46e5;
            padding: 1.2rem 2.5rem; border-radius: 30px; text-decoration: none;
            margin-top: 2rem; font-weight: 700; font-size: 1.2rem;
            transition: all 0.3s ease; box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .manual-button:hover {
            background: white; color: #4f46e5; text-decoration: none;
            transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        
        .footer-info {
            margin-top: 3rem; font-size: 0.9rem; opacity: 0.75; line-height: 1.6;
        }
        
        .error-state { color: #fbbf24; font-weight: 600; }
        .success-state { color: #4ade80; font-weight: 600; }
        .loading-dots { display: inline-block; animation: loadingDots 1.5s infinite; }
        
        @keyframes loadingDots {
            0%, 20% { color: rgba(255,255,255,0.4); }
            40% { color: rgba(255,255,255,0.8); }
            60% { color: rgba(255,255,255,1); }
            80%, 100% { color: rgba(255,255,255,0.4); }
        }
        
        .debug-info {
            background: rgba(255, 255, 255, 0.1); padding: 1rem;
            border-radius: 15px; margin: 1rem 0; font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left; direction: ltr;
            font-family: 'Courier New', monospace;
        }
        
        .processing-steps {
            background: rgba(255, 255, 255, 0.1); padding: 1rem;
            border-radius: 15px; margin: 1rem 0; font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .step-item {
            margin: 0.5rem 0; padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px; display: flex;
            align-items: center; justify-content: space-between;
        }
        
        .step-success { background: rgba(34, 197, 94, 0.3); }
        .step-failed { background: rgba(239, 68, 68, 0.3); }
        .step-processing { background: rgba(251, 191, 36, 0.3); animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        
        <h1 id="title">ğŸŒ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ø°ÙƒÙŠ<span class="loading-dots">...</span></h1>
        
        <div class="status" id="status">
            ğŸ”§ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ ÙˆØªØ±Ù…ÙŠØ² Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...
        </div>
        
        <div class="processing-steps" id="processingSteps">
            <div class="step-item step-processing" id="step1">
                <span>ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª URL</span>
                <span>â³</span>
            </div>
            <div class="step-item" id="step2">
                <span>ğŸ”§ ØªØ·Ø¨ÙŠØ¹ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ø¨Ø·</span>
                <span>â³</span>
            </div>
            <div class="step-item" id="step3">
                <span>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                <span>â³</span>
            </div>
            <div class="step-item" id="step4">
                <span>ğŸš€ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</span>
                <span>â³</span>
            </div>
        </div>
        
        <div class="debug-info" id="debugInfo" style="display: none;">
            <strong>Debug Information:</strong><br>
            <div id="debugContent"></div>
        </div>
        
        <div class="url-display" id="urlDisplay" style="display: none;">
            <div class="url-label">ğŸ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</div>
            <div class="url-value" id="targetUrl"></div>
            <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                <span id="methodUsed"></span>
            </div>
        </div>
        
        <a href="#" class="manual-button" id="manualButton" style="display: none;">
            ğŸ”— Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
        </a>
        
        <div class="footer-info">
            ğŸŒ Ù†Ø¸Ø§Ù… ØªØ±Ù…ÙŠØ² Ø°ÙƒÙŠ - ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„ØºØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹<br>
            ğŸ‡ªğŸ‡¬ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â€¢ Ù…Ø¬Ø§Ù†ÙŠ 100% â€¢ Ø¢Ù…Ù† ÙˆÙ…ØªØ·ÙˆØ±
        </div>
    </div>
    
    <script>
        // Configuration
        const CONFIG = {
            GITHUB_API_BASE: 'https://api.github.com/repos/sherow1982/arabic-ads-calculator-tools',
            BASE_URL: 'https://sherow1982.github.io/arabic-ads-calculator-tools',
            LINK_DB_URL: 'https://sherow1982.github.io/arabic-ads-calculator-tools/link-db.json',
            DEBUG_MODE: true
        };
        
        function debugLog(message, data = null) {
            if (CONFIG.DEBUG_MODE) {
                console.log(message, data);
                const debugContent = document.getElementById('debugContent');
                if (debugContent) {
                    debugContent.innerHTML += `${message}<br>${data ? JSON.stringify(data, null, 2) + '<br>' : ''}`;
                }
            }
        }
        
        function updateStepStatus(stepId, status) {
            const element = document.getElementById(stepId);
            if (!element) return;
            
            const statusIcon = element.querySelector('span:last-child');
            element.classList.remove('step-processing', 'step-success', 'step-failed');
            
            if (status === 'processing') {
                element.classList.add('step-processing');
                statusIcon.textContent = 'â³';
            } else if (status === 'success') {
                element.classList.add('step-success');
                statusIcon.textContent = 'âœ…';
            } else {
                element.classList.add('step-failed');
                statusIcon.textContent = 'âŒ';
            }
        }
        
        function getShortCode() {
            const urlParams = new URLSearchParams(window.location.search);
            let shortCode = urlParams.get('to') || urlParams.get('url') || urlParams.get('go') || urlParams.get('redirect');
            
            debugLog('Raw short code from URL:', shortCode);
            
            if (shortCode) {
                // Try to decode if it looks like an encoded URL
                try {
                    const decoded = decodeURIComponent(shortCode);
                    debugLog('Decoded short code:', decoded);
                    
                    // If decoded version looks like a full URL, use it directly
                    if (decoded.startsWith('http://') || decoded.startsWith('https://')) {
                        debugLog('Direct URL mode detected');
                        return { type: 'direct_url', value: decoded };
                    }
                } catch (e) {
                    debugLog('Decode failed, using original:', e.message);
                }
            }
            
            return shortCode ? { type: 'code', value: shortCode } : null;
        }
        
        function normalizeUrl(url) {
            if (!url) return url;
            
            try {
                debugLog('Normalizing URL:', url);
                
                // Add protocol if missing
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                // Parse URL to normalize components
                const urlObj = new URL(url);
                
                // Normalize pathname: remove /./ and resolve ../ 
                let pathname = urlObj.pathname;
                pathname = pathname.replace(/\/\.\//, '/'); // Remove /./
                pathname = pathname.replace(/\/+/g, '/'); // Remove multiple slashes
                
                // Handle special cases for Arabic paths
                if (pathname.includes('%')) {
                    try {
                        // Try to decode and re-encode properly
                        pathname = decodeURIComponent(pathname);
                        pathname = encodeURIComponent(pathname).replace(/%2F/g, '/');
                    } catch (e) {
                        debugLog('Path normalization warning:', e.message);
                    }
                }
                
                // Rebuild URL with normalized components
                const normalized = `${urlObj.protocol}//${urlObj.host}${pathname}${urlObj.search}${urlObj.hash}`;
                
                debugLog('Normalized URL:', normalized);
                return normalized;
                
            } catch (error) {
                debugLog('URL normalization failed:', error.message);
                return url; // Return original if normalization fails
            }
        }
        
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        function showError(message) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('title').innerHTML = 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·';
            document.getElementById('status').innerHTML = `<span class="error-state">${message}</span>`;
            
            // Show debug info
            document.getElementById('debugInfo').style.display = 'block';
            
            // Show home button
            const manualButton = document.getElementById('manualButton');
            manualButton.href = CONFIG.BASE_URL;
            manualButton.innerHTML = 'ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
            manualButton.style.display = 'inline-block';
        }
        
        function showSuccess(targetUrl, shortCode, source = 'unknown') {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('title').innerHTML = 'ğŸ‰ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·!';
            document.getElementById('status').innerHTML = `<span class="success-state">Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø®Ù„Ø§Ù„ Ø«Ø§Ù†ÙŠØªÙŠÙ†...</span>`;
            
            // Show target URL
            document.getElementById('targetUrl').innerHTML = targetUrl;
            document.getElementById('urlDisplay').style.display = 'block';
            
            // Show which method worked
            const methodNames = {
                'direct_url': 'ğŸ”— Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± (ØªÙ… ÙÙƒ Ø§Ù„ØªØ±Ù…ÙŠØ²)',
                'json-db': 'ğŸ“¦ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª JSON',
                'github-issues': 'ğŸ“‹ GitHub Issues',
                'html-files': 'ğŸ“„ Ù…Ù„ÙØ§Øª HTML ÙØ±Ø¯ÙŠØ©',
                'auto-generated': 'ğŸ¤– ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'
            };
            document.getElementById('methodUsed').textContent = `Ø§Ù„Ù…ØµØ¯Ø±: ${methodNames[source] || source}`;
            
            // Show manual button
            const manualButton = document.getElementById('manualButton');
            manualButton.href = targetUrl;
            manualButton.innerHTML = 'ğŸš€ Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙÙˆØ±ÙŠ';
            manualButton.style.display = 'inline-block';
            
            // Show debug info if enabled
            if (CONFIG.DEBUG_MODE) {
                document.getElementById('debugInfo').style.display = 'block';
            }
        }
        
        // Enhanced JSON Database lookup with fallbacks
        async function tryJsonDatabase(shortCode) {
            try {
                updateStepStatus('step3', 'processing');
                debugLog('Searching JSON database for:', shortCode);
                
                const response = await fetch(`${CONFIG.LINK_DB_URL}?t=${Date.now()}`, { 
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    debugLog('JSON database loaded successfully');
                    
                    if (data.links && data.links[shortCode]) {
                        const linkData = data.links[shortCode];
                        const targetUrl = normalizeUrl(linkData.url);
                        
                        if (isValidUrl(targetUrl)) {
                            debugLog('Found in JSON database:', { shortCode, targetUrl, linkData });
                            updateStepStatus('step3', 'success');
                            return targetUrl;
                        }
                    }
                }
                
                debugLog('Not found in JSON database');
                updateStepStatus('step3', 'failed');
                
            } catch (error) {
                debugLog('JSON database error:', error.message);
                updateStepStatus('step3', 'failed');
            }
            
            return null;
        }
        
        // Direct URL processing (when the shortCode IS the target URL)
        function processDirectUrl(encodedUrl) {
            try {
                updateStepStatus('step2', 'processing');
                debugLog('Processing direct URL:', encodedUrl);
                
                // Normalize the URL
                const normalizedUrl = normalizeUrl(encodedUrl);
                
                if (isValidUrl(normalizedUrl)) {
                    debugLog('Direct URL is valid:', normalizedUrl);
                    updateStepStatus('step2', 'success');
                    return normalizedUrl;
                }
                
                debugLog('Direct URL validation failed');
                updateStepStatus('step2', 'failed');
                
            } catch (error) {
                debugLog('Direct URL processing error:', error.message);
                updateStepStatus('step2', 'failed');
            }
            
            return null;
        }
        
        // Enhanced GitHub Issues lookup
        async function tryGitHubIssues(shortCode) {
            try {
                debugLog('Searching GitHub Issues for:', shortCode);
                
                const issueNumber = parseInt(shortCode);
                if (!isNaN(issueNumber) && issueNumber > 0) {
                    const issueResponse = await fetch(`${CONFIG.GITHUB_API_BASE}/issues/${issueNumber}`);
                    if (issueResponse.ok) {
                        const issue = await issueResponse.json();
                        if (issue.title && isValidUrl(issue.title)) {
                            const normalizedUrl = normalizeUrl(issue.title);
                            debugLog('Found in GitHub Issues:', { issueNumber, originalUrl: issue.title, normalizedUrl });
                            return normalizedUrl;
                        }
                    }
                }
                
                debugLog('Not found in GitHub Issues');
                
            } catch (error) {
                debugLog('GitHub Issues error:', error.message);
            }
            
            return null;
        }
        
        async function performRedirect() {
            updateStepStatus('step1', 'processing');
            
            const shortCodeData = getShortCode();
            debugLog('Short code data:', shortCodeData);
            
            if (!shortCodeData) {
                updateStepStatus('step1', 'failed');
                showError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù…Ø² Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†. <br><br>ğŸ’¡ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:<br>â€¢ <code>?to=Ø±Ù…Ø²</code> - Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª<br>â€¢ <code>?to=Ø±Ø§Ø¨Ø·_ÙƒØ§Ù…Ù„</code> - Ù„Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±<br><br>Ø£Ù…Ø«Ù„Ø©:<br>â€¢ <code>s.html?to=test</code><br>â€¢ <code>s.html?to=https%3A//example.com</code>');
                return;
            }
            
            updateStepStatus('step1', 'success');
            let targetUrl = null;
            let source = '';
            
            // Handle direct URL mode
            if (shortCodeData.type === 'direct_url') {
                targetUrl = processDirectUrl(shortCodeData.value);
                if (targetUrl) {
                    source = 'direct_url';
                    updateStepStatus('step4', 'success');
                }
            } 
            // Handle code lookup mode
            else {
                updateStepStatus('step2', 'success'); // Skip normalization for codes
                
                // Try JSON database first
                targetUrl = await tryJsonDatabase(shortCodeData.value);
                if (targetUrl) {
                    source = 'json-db';
                    updateStepStatus('step4', 'success');
                } else {
                    // Try GitHub Issues as fallback
                    targetUrl = await tryGitHubIssues(shortCodeData.value);
                    if (targetUrl) {
                        source = 'github-issues';
                        updateStepStatus('step4', 'success');
                    }
                }
            }
            
            if (!targetUrl) {
                updateStepStatus('step4', 'failed');
                showError(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ¬Ù‡Ø© Ù„Ù„Ø±Ù…Ø²: "${shortCodeData.value}"<br><br>ğŸ’¡ Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯:<br>1. Ø§Ø³ØªØ®Ø¯Ù… <a href="tools/url-shortener.html" style="color: #fbbf24; text-decoration: underline;">Ø£Ø¯Ø§Ø© Ù…Ø®ØªØµØ± Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</a><br>2. Ø£Ùˆ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù…Ø² ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø¨Ø± <a href="https://wa.me/201110760081" style="color: #fbbf24; text-decoration: underline;">ÙˆØ§ØªØ³Ø§Ø¨</a>`);
                return;
            }
            
            showSuccess(targetUrl, shortCodeData.value, source);
            
            // Analytics tracking
            if (typeof gtag !== 'undefined') {
                gtag('event', 'smart_redirect', {
                    'short_code': shortCodeData.value,
                    'short_code_type': shortCodeData.type,
                    'target_url': targetUrl,
                    'source_method': source,
                    'user_agent': navigator.userAgent,
                    'timestamp': new Date().toISOString()
                });
            }
            
            // Perform redirect
            setTimeout(() => {
                debugLog('Performing redirect to:', targetUrl);
                window.location.href = targetUrl;
            }, 2000);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM loaded, starting smart redirect process...');
            performRedirect();
        });
        
        // Fallback for already loaded DOM
        if (document.readyState !== 'loading') {
            debugLog('DOM already loaded, starting immediately...');
            performRedirect();
        }
        
        // Emergency fallback
        setTimeout(() => {
            debugLog('Emergency fallback triggered - redirecting to home');
            window.location.href = CONFIG.BASE_URL;
        }, 20000);
        
        // Manual redirect on click
        document.addEventListener('click', function() {
            const manualButton = document.getElementById('manualButton');
            if (manualButton && manualButton.style.display !== 'none' && manualButton.href !== '#') {
                debugLog('Manual redirect triggered');
                window.location.href = manualButton.href;
            }
        });
        
        // Show debug info toggle (for development)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'D' && e.ctrlKey) {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>