/* SheetJS XLSX Library - Working Loader for File Downloads
 * Ensures XLSX files are properly downloaded to user's computer
 * Version: 0.18.5 from https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js
 */

// ุชุญููู ููุฑู ูููุซูู ูููุชุจุฉ XLSX
(function loadXLSXLibrary() {
  // ุชุญูู ูู ุนุฏู ูุฌูุฏ ุงูููุชุจุฉ ูุณุจูุงู
  if (window.XLSX && window.XLSX.writeFile) {
    console.log('โ XLSX ูุญููู ูุณุจูุงู');
    return;
  }

  // ุฅูุดุงุก ูุชูููุฐ ุนูุตุฑ script ูุชุญููู ุงูููุชุจุฉ ุงููุงููุฉ
  const script = document.createElement('script');
  script.type = 'text/javascript';
  
  // ุงุณุชุฎุฏุงู ุฃุญุฏุซ CDN ููุซูู
  script.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
  script.async = false; // ุชุญููู ูุชุฒุงูู ูุถูุงู ุงูุฌุงูุฒูุฉ ูุจู ุงูุงุณุชุฎุฏุงู
  script.crossOrigin = 'anonymous'; // ููุน ูุดุงูู CORS
  
  // ุนูุฏ ูุฌุงุญ ุงูุชุญููู
  script.onload = function() {
    console.log('โ ุชู ุชุญููู ููุชุจุฉ XLSX ุจูุฌุงุญ - ุฒุฑ ุชูุฒูู XLSX ุฌุงูุฒ ุงูุขู!');
    
    // ุชูุนูู ุฒุฑ XLSX ุฅุฐุง ูุงู ูุนุทูุงู
    const xlsxBtn = document.getElementById('exportXlsx');
    if (xlsxBtn) {
      xlsxBtn.disabled = false;
      xlsxBtn.style.opacity = '1';
      xlsxBtn.title = 'ุฌุงูุฒ ูุชูุฒูู ูููุงุช XLSX ุนูู ุฌูุงุฒู';
    }
    
    // ุฅุดุนุงุฑ ุจููุฉ ุฃุฌุฒุงุก ุงูุตูุญุฉ
    window.dispatchEvent(new CustomEvent('xlsxReady', {detail: window.XLSX}));
  };
  
  // ุนูุฏ ูุดู ุงูุชุญููู
  script.onerror = function() {
    console.warn('โ ูุดู ุชุญููู XLSX ูู CDN - ุณุชุนูู ุฃุฏูุงุช CSV ุจุฏููุฉ');
    
    // ุฅูุดุงุก stub ุจุณูุท ูุนูุฏ ุชูุฌูู ูู CSV ุนูุฏ ูุญุงููุฉ ุงุณุชุฎุฏุงู XLSX
    window.XLSX = {
      utils: {
        book_new: () => ({SheetNames:[], Sheets:{}}),
        aoa_to_sheet: () => ({}),
        book_append_sheet: () => {}
      },
      writeFile: () => {
        alert('โ ูุง ูููู ุชูุฒูู XLSX ุญุงููุงู ุจุณุจุจ ูุดููุฉ ูู ุงูุงุชุตุงู. ุณูุชู ุชูุฒูู CSV ุจุฏูุงู ูู ุฐูู.');
        // ุชุดุบูู CSV ุจุฏูู ุชููุงุฆู
        const csvBtn = document.getElementById('exportGoogleAds');
        if (csvBtn) csvBtn.click();
        return false;
      }
    };
    
    // ุชุนุทูู ุฒุฑ XLSX ูุชูุฌูู ูู CSV
    const xlsxBtn = document.getElementById('exportXlsx');
    if (xlsxBtn) {
      xlsxBtn.disabled = true;
      xlsxBtn.style.opacity = '0.6';
      xlsxBtn.title = 'ุบูุฑ ูุชุงุญ ุญุงููุงู - ุงุณุชุฎุฏู CSV ุจุฏูุงู ูู ุฐูู';
    }
  };
  
  // ุชุนุทูู ุฒุฑ XLSX ูุคูุชุงู ุญุชู ููุชูู ุงูุชุญููู
  const xlsxBtn = document.getElementById('exportXlsx');
  if (xlsxBtn) {
    xlsxBtn.disabled = true;
    xlsxBtn.style.opacity = '0.7';
    xlsxBtn.innerHTML = '๐ ุฌุงุฑู ุชุญููู XLSX...';
  }
  
  // ุฅุถุงูุฉ ุงูุณูุฑูุจุช ุฅูู ุงูุตูุญุฉ
  document.head.appendChild(script);
  
  // ุงุณุชุนุงุฏุฉ ูุต ุงูุฒุฑ ุนูุฏ ุงูุชูุงุก ุงูุชุญููู (ูุฌุงุญ ุฃู ูุดู)
  window.addEventListener('xlsxReady', () => {
    if (xlsxBtn) {
      xlsxBtn.disabled = false;
      xlsxBtn.style.opacity = '1';
      xlsxBtn.innerHTML = '๐ ุชูุฒูู XLSX ูุชูุฏู';
    }
  });
  
  // Timeout ููุญุงูุงุช ุงูุจุทูุฆุฉ
  setTimeout(() => {
    if (!window.XLSX || !window.XLSX.writeFile) {
      console.warn('ุงูุชูู ุฒูู ุชุญููู XLSX - ุงุณุชุฎุฏุงู ุจุฏูู CSV');
      script.onerror(); // ุชุดุบูู ูุนุงูุฌ ุงููุดู
    }
  }, 10000); // 10 ุซูุงูู timeout
})();