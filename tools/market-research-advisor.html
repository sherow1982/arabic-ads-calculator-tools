<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…ÙØ±Ø´ÙÙ‘Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©</title>
  <link rel="icon" href="../favicon.svg">
  <link rel="stylesheet" href="../global-styles.css" />
  <style>
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:18px;margin:12px 0;box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .grid{display:grid;gap:16px}
    @media(min-width:960px){.grid{grid-template-columns:repeat(3,1fr)}}
    .muted{color:#666;font-size:.92rem}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi div{background:#f6f7f9;border:1px solid #e7e9ee;border-radius:10px;padding:10px 12px}
    .pill{display:inline-block;background:#eef6ff;color:#1453b3;border:1px solid #cfe3ff;padding:4px 10px;border-radius:999px;margin:2px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .warn{color:#b80}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row .col{flex:1 1 260px}
    .small{font-size:.85rem}
    .error{background:#ffe8e6;color:#b10;border:1px solid #f3b1aa;padding:10px 12px;border-radius:10px;margin:10px 0;display:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{background:var(--gradient);color:#fff;border:none;border-radius:20px;padding:8px 14px;cursor:pointer}
    .platforms{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .platforms label{display:flex;align-items:center;gap:6px;background:#f6f7f9;border:1px solid #e7e9ee;border-radius:999px;padding:6px 10px;cursor:pointer}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1>ğŸ¯ Ù…ÙØ±Ø´ÙÙ‘Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ (Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø©)</h1>
    <p class="muted">Ù…ØµØ¯Ø± ÙƒÙ„Ù…Ø§Øª Ø¨Ø­Ø« Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ù…Ø¬Ø§Ù†ÙŠ) Ù…Ù† Google Autocomplete Ø¹Ø±Ø¨ÙŠØ§Ù‹ØŒ Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø§Ù„ØµÙ„Ø© Ø¨Ø§Ù„Ù…Ø¬Ø§Ù„ØŒ ÙˆØªØµØ¯ÙŠØ± XLSX. ÙŠØ¯Ø¹Ù… Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬.</p>

    <div id="err" class="error">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆÙ„. Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© (Ctrl+F5).</div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
          <input id="country" list="countries" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŒ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª" disabled />
          <datalist id="countries"></datalist>
        </div>
        <div class="col">
          <label>Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ (Ø£ÙƒØªØ¨ Ø¨Ø­Ø±ÙŠØ©)</label>
          <input id="sectorFree" placeholder="Ù…Ø«Ø§Ù„: Ù†Ù‚Ù„ Ø£Ø«Ø§Ø«ØŒ Ø´Ø±ÙƒØ© Ù†Ø¸Ø§ÙØ©ØŒ Ø´Ø±ÙƒØ© ØµØ±Ù ØµØ­ÙŠ" />
        </div>
        <div class="col">
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <input id="currency" disabled />
        </div>
      </div>

      <div class="row inline">
        <div>
          <label>Ù…ØµØ¯Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label>
          <select id="source">
            <option value="google">Google Autocomplete (Ù…Ø¬Ø§Ù†ÙŠ)</option>
            <option value="local">ØªÙˆÙ„ÙŠØ¯ Ù…Ø­Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª)</option>
          </select>
        </div>
        <div>
          <label>ØªÙˆØ³ÙŠØ¹ Aâ€“Z</label>
          <input type="checkbox" id="expandAZ" checked />
        </div>
        <div>
          <label>Ù„Ù‡Ø¬Ø©</label>
          <select id="dialect">
            <option value="std" selected>Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰</option>
            <option value="gcc">Ø®Ù„ÙŠØ¬ÙŠ</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:1 1 100%">
          <label>Ø§Ù„Ù…Ù†ØµØ§Øª (ÙØ¹Ù‘Ù„/Ø£ÙˆÙ‚Ù)</label>
          <div class="platforms" id="platformToggles"></div>
        </div>
      </div>

      <button id="run" disabled>Ø¬Ù„Ø¨ ÙƒÙ„Ù…Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© + ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©</button>
      <div class="actions">
        <button id="copyTop30" class="btn" disabled>Ù†Ø³Ø® Ø£ÙØ¶Ù„ 30</button>
        <button id="exportXlsx" class="btn" disabled>ØªÙ†Ø²ÙŠÙ„ XLSX</button>
      </div>
      <p class="small warn">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Autocomplete Ù…Ø¬Ø§Ù†ÙŠØ© ÙˆÙ‚Ø¯ ØªÙÙ‚ÙŠÙ‘ÙØ¯ Ø¨Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø±ÙŠØ¹. Ø¹Ù†Ø¯ Ù‚Ù„Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ Ø£Ø¶Ù Ù…Ø¯ÙŠÙ†Ø©/Ø®Ø¯Ù…Ø© ÙØ±Ø¹ÙŠØ©.</p>
    </div>

    <div id="out" style="display:none">
      <div class="card">
        <h2>ğŸ”‘ ÙƒÙ„Ù…Ø§Øª Ø¨Ø­Ø« Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…Ø¬Ø§Ù„Ùƒ</h2>
        <div id="keywords" class="chips"></div>
      </div>

      <div class="card">
        <h2>âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØµØ§Øª ÙˆÙ…Ø²ÙŠØ¬ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h2>
        <div id="mix" class="chips"></div>
        <p class="muted small" id="mixNote"></p>
      </div>

      <div class="card">
        <h2>ğŸ’° ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­</h2>
        <div id="allocation" class="kpi"></div>
      </div>

      <div class="card">
        <h2>ğŸ“ˆ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù…ÙØµÙ„Ø©</h2>
        <div id="forecasts" class="kpi"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="js/xlsx-exporter.js"></script>
  <script>
    const GCC_GL = { 'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©':'sa', 'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª':'ae', 'Ø§Ù„ÙƒÙˆÙŠØª':'kw', 'Ù‚Ø·Ø±':'qa', 'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†':'bh', 'Ø¹ÙÙ…Ø§Ù†':'om' };
    const ALL_PLATFORMS=['Google Ads','Facebook','Instagram','TikTok','Snapchat','YouTube','LinkedIn'];
    function normalize(s){ return (s||'').toLowerCase().replace(/[\u064B-\u0652]/g,'').trim(); }

    function deriveSynonyms(base, dialect){
      const b=normalize(base); const syn=new Set();
      const tokens=b.split(/\s+/).filter(Boolean); tokens.forEach(t=> syn.add(t.replace(/[Ø©Ù‡]/g,'Ù‡').replace(/[Ø¢Ø£Ø¥Ø§]/g,'Ø§')));
      if(/Ù†Ù‚Ù„/.test(b)) ['Ù†Ù‚Ù„','ØªØ±Ø­ÙŠÙ„','Ø´Ø­Ù†','ØªØ­Ù…ÙŠÙ„','ØªÙ†Ø²ÙŠÙ„'].forEach(x=>syn.add(x));
      if(/Ø¹ÙØ´|Ø§Ø«Ø§Ø«|Ù…ÙˆØ¨ÙŠÙ„ÙŠØ§/.test(b)) ['Ø¹ÙØ´','Ø§Ø«Ø§Ø«','Ù…ÙˆØ¨ÙŠÙ„ÙŠØ§','Ø§Ø«Ø§Ø« Ù…Ù†Ø²Ù„ÙŠ','Ø§Ø«Ø§Ø« Ù…ÙƒØªØ¨ÙŠ'].forEach(x=>syn.add(x));
      if(dialect==='gcc' && /Ù†Ù‚Ù„/.test(b)) ['Ù†Ù‚Ù„ Ø¹ÙØ´','Ø¯ÙŠÙ†Ø§ Ù†Ù‚Ù„','Ø³Ø·Ø­Ù‡ Ù†Ù‚Ù„'].forEach(x=>syn.add(normalize(x)));
      if(/Ù†Ø¸Ø§ÙÙ‡|ØªÙ†Ø¸ÙŠÙ/.test(b)) ['ØªÙ†Ø¸ÙŠÙ','ØªØ¹Ù‚ÙŠÙ…','ØºØ³ÙŠÙ„','ØªÙ„Ù…ÙŠØ¹'].forEach(x=>syn.add(x));
      if(/ØµØ±Ù|Ù…Ø¬Ø§Ø±ÙŠ/.test(b)) ['ØµØ±Ù ØµØ­ÙŠ','Ù…Ø¬Ø§Ø±ÙŠ','ØªØ³Ù„ÙŠÙƒ','Ø´ÙØ·','Ø¨ÙŠØ§Ø±Ø§Øª','Ø¨ÙŠØ§Ø±Ù‡'].forEach(x=>syn.add(x));
      return Array.from(syn);
    }

    async function fetchGoogleSuggest(q, gl){
      const url = `https://suggestqueries.google.com/complete/search?client=chrome&hl=ar&gl=${gl}&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!res.ok) return [];
      const data = await res.json();
      // Ø´ÙƒÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© client=chrome: [query, [suggestions...]]
      return Array.isArray(data) && Array.isArray(data[1]) ? data[1] : [];
    }

    async function expandSuggestions(base, gl){
      const letters = ' Ø§Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠabcdefghijklmnopqrstuvwxyz'.split('');
      const batches = [base, ...letters.slice(0,12).map(l=> `${base} ${l}`)]; // ØªÙˆØ³ÙŠØ¹ Ù…Ø­Ø¯ÙˆØ¯ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª
      const out=new Set();
      for(const b of batches){
        try{ const sug = await fetchGoogleSuggest(b, gl); sug.forEach(s=> out.add(s)); }
        catch(e){}
        await new Promise(r=> setTimeout(r, 200)); // ØªÙ‡Ø¯Ø¦Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„
      }
      return Array.from(out);
    }

    function filterRelevant(suggestions, syns){
      const sn = syns.map(s=> normalize(s));
      return suggestions.filter(s=>{ const x=normalize(s); return sn.some(r=> x.includes(r)); });
    }

    async function load(){
      const res=await fetch('../data/ads-country-benchmarks.json',{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); return await res.json();
    }
    function fmt(n){ return new Intl.NumberFormat('ar-EG').format(Math.round(n||0)); }

    (async function init(){
      try{
        const data=await load();
        const countries=data.countries||{};
        const cList=document.getElementById('countries');
        ['Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©','Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª','Ø§Ù„ÙƒÙˆÙŠØª','Ù‚Ø·Ø±','Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†','Ø¹ÙÙ…Ø§Ù†'].forEach(name=>{ const o=document.createElement('option'); o.value=name; cList.appendChild(o); });

        const runBtn=document.getElementById('run'); const copyBtn=document.getElementById('copyTop30'); const xlsxBtn=document.getElementById('exportXlsx');
        document.getElementById('country').disabled=false; runBtn.disabled=false; copyBtn.disabled=false; xlsxBtn.disabled=false;

        const toggles=document.getElementById('platformToggles'); ALL_PLATFORMS.forEach(p=>{ const id='pl_'+p.replace(/\s+/g,'_'); const label=document.createElement('label'); label.innerHTML=`<input type="checkbox" id="${id}" checked> ${p}`; toggles.appendChild(label); });

        runBtn.addEventListener('click', async ()=>{
          const cVal=document.getElementById('country').value.trim();
          const sectorFree=document.getElementById('sectorFree').value.trim();
          const source=document.getElementById('source').value;
          const expand=document.getElementById('expandAZ').checked;
          const dialect=document.getElementById('dialect').value;
          if(!cVal||!sectorFree){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø¯ÙˆÙ„Ø© ÙˆØ§ÙƒØªØ¨ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„'); return; }
          const gl=GCC_GL[cVal]||'sa';

          // ÙƒÙ„Ù…Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
          let suggestions=[];
          if(source==='google'){
            if(expand) suggestions = await expandSuggestions(sectorFree, gl); else suggestions = await fetchGoogleSuggest(sectorFree, gl);
          }
          // ÙÙ„ØªØ±Ø© Ø§Ù„ØµÙ„Ø©
          const syns = deriveSynonyms(sectorFree, dialect);
          let kws = filterRelevant(suggestions, syns);
          if(kws.length<30){ // Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¥Ù„Ù‰ 30 Ø¨ØµÙŠØº Ù†ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ø¬Ø°ÙˆØ±
            const intents=['Ø³Ø¹Ø±','Ø§Ø³Ø¹Ø§Ø±','ØªÙƒÙ„ÙÙ‡','Ù‚Ø±ÙŠØ¨','Ø¨Ø§Ù„Ù‚Ø±Ø¨','Ø­Ø¬Ø²','Ø·Ù„Ø¨','Ø±Ù‚Ù…','Ù‡Ø§ØªÙ','Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†'];
            for(const r of syns){ for(const i of intents){ if(kws.length>=30) break; const combo=`${r} ${i}`; if(!kws.includes(combo)) kws.push(combo); } if(kws.length>=30) break; }
          }
          kws = kws.slice(0,100); // ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø£ÙƒØ«Ø± Ù…Ù† 30 Ø§Ù„Ø¢Ù†

          const kwEl=document.getElementById('keywords'); kwEl.innerHTML='';
          kws.forEach(k=>{ const span=document.createElement('span'); span.className='pill'; span.textContent=k; kwEl.appendChild(span); });
          copyBtn.onclick = ()=>{ navigator.clipboard.writeText(kws.slice(0,30).join('\n')).then(()=> alert('ØªÙ… Ù†Ø³Ø® Ø£ÙØ¶Ù„ 30 ÙƒÙ„Ù…Ø©')); };
          xlsxBtn.onclick = ()=>{ const rows = [['Ø§Ù„ÙƒÙ„Ù…Ø©','Ù…Ù„Ø§Ø­Ø¸Ø©'], ...kws.map(k=> [k,''])]; if(window.__XLSX_EXPORT__) window.__XLSX_EXPORT__.downloadXlsx('arabic-keywords.xlsx', rows); else alert('Ù…ÙƒÙˆÙ† XLSX ØºÙŠØ± Ù…ÙØ­Ù…Ù‘Ù„'); };

          // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ø§Ù„Ù…Ø²ÙŠØ¬/Ø§Ù„ØªÙˆØ²ÙŠØ¹/Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª) ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø©
          const country = Object.values(countries).find(c=> c.name===cVal) || null; if(country) document.getElementById('currency').value=country.currency||'';
          const activePlatforms = ALL_PLATFORMS.filter(p=> document.getElementById('pl_'+p.replace(/\s+/g,'_')).checked);
          const r=country?.budget_ranges||{small:{min:2000,max:8000}}; const monthly= Math.round((r.small.min+r.small.max)/2); const campaignBudget=Math.max(200, Math.round((monthly/30)*30));
          const cpm=country?.avg_cpm||{}; const recommended=(country?.recommended_platforms||[]).filter(p=> activePlatforms.includes(p));
          const top=[...recommended].sort((a,b)=>(cpm[a]||99)-(cpm[b]||99)).slice(0,Math.min(3,activePlatforms.length));
          const mix=[]; top.forEach(p=> mix.push({platform:p}));
          const equal= activePlatforms.length? campaignBudget/activePlatforms.length : campaignBudget;
          const allocation = activePlatforms.map(p=> ({platform:p, amount: equal}));
          const mixEl=document.getElementById('mix'); mixEl.innerHTML=''; activePlatforms.forEach((p,i)=>{ const s=document.createElement('span'); s.className='pill'; s.textContent=`${i+1} - ${p}`; mixEl.appendChild(s); });
          document.getElementById('mixNote').textContent=`ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØµØ§Øª Ø§Ù„Ù…ÙØ¹Ù‘Ù„Ø© ÙÙ‚Ø·: ${activePlatforms.join('ØŒ ')}`;
          const allocEl=document.getElementById('allocation'); allocEl.innerHTML=''; allocation.forEach(a=>{ const d=document.createElement('div'); d.innerHTML=`<b>${a.platform}</b><br>${fmt(a.amount)} ${country?.currency||''}`; allocEl.appendChild(d); });
          const fEl=document.getElementById('forecasts'); fEl.innerHTML=''; let totals={impressions:0,clicks:0,conversions:0,sales:0}; allocation.forEach(a=>{ const cp=(cpm[a.platform]||2); const impressions=(a.amount/cp)*1000; const clicks=impressions*0.012; const conversions=clicks*0.02; const sales=conversions*0.7; totals.impressions+=impressions; totals.clicks+=clicks; totals.conversions+=conversions; totals.sales+=sales; const div=document.createElement('div'); div.innerHTML=`<b>${a.platform}</b><br>CPM $${cp.toFixed(2)} | CTR 1.2% | CVR 2.0%<br>Ø§Ù„Ø¸Ù‡ÙˆØ± ${fmt(impressions)} | Ø§Ù„Ù†Ù‚Ø±Ø§Øª ${fmt(clicks)} | Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ${fmt(conversions)} | Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ${fmt(sales)}`; fEl.appendChild(div); });
          const totalDiv=document.createElement('div'); totalDiv.innerHTML=`<b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (${fmt(campaignBudget)} ${country?.currency||''})</b><br>Ø§Ù„Ø¸Ù‡ÙˆØ± ${fmt(totals.impressions)} | Ø§Ù„Ù†Ù‚Ø±Ø§Øª ${fmt(totals.clicks)} | Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ${fmt(totals.conversions)} | Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ${fmt(totals.sales)}`; fEl.appendChild(totalDiv);

          document.getElementById('out').style.display='block';
        });
      }catch(e){ document.getElementById('err').style.display='block'; }
    })();
  </script>
</body>
</html>
