<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ Ù…Ø®ØªØµØ± Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{background:linear-gradient(135deg,#667eea,#764ba2);font-family:'Cairo',sans-serif}
    .card{backdrop-filter: blur(12px);background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3)}
    .mode .btn{border-radius:999px}
    textarea{direction:ltr;font-family:monospace}
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="card p-3 mb-3">
      <div class="d-flex gap-2 mode mb-2">
        <button id="tabShort" class="btn btn-primary btn-sm">ØªÙ‚ØµÙŠØ±</button>
        <button id="tabPretty" class="btn btn-outline-primary btn-sm">ØªØ¬Ù…ÙŠÙ„</button>
        <button id="tabBoth" class="btn btn-outline-primary btn-sm">ÙƒÙ„Ø§Ù‡Ù…Ø§</button>
        <button id="cleanBtn" class="btn btn-outline-warning btn-sm ms-auto">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
        <button id="backlinkBtn" class="btn btn-danger btn-sm">Ø¨Ø§Ùƒ Ù„ÙŠÙ†Ùƒ (10 Ù…ÙˆØ§Ù‚Ø¹)</button>
      </div>
      <div class="row g-2 text-white small mb-2">
        <div class="col">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="totalCount">0</b></div>
        <div class="col">ØµØ§Ù„Ø­Ø©: <b id="validCount">0</b></div>
        <div class="col">Ù…ÙƒØ±Ø±Ø©: <b id="duplicateCount">0</b></div>
        <div class="col">ØºÙŠØ± ØµØ§Ù„Ø­Ø©: <b id="invalidCount">0</b></div>
      </div>
      <textarea id="urlInput" class="form-control" rows="7" placeholder="https://kuwait-matjar.arabsad.com/./product.html?name=3-Ù‚Ø·Ø¹-ÙƒØ§Ù…ÙŠØ±Ø§-Ù…Ø±Ø§Ù‚Ø¨Ø©-ØªØ¹Ù…Ù„-Ø¨Ø§Ù„Ø·Ø§Ù‚Ø©-Ø§Ù„Ø´Ù…Ø³ÙŠØ©"></textarea>
      <div class="d-flex gap-2 mt-2">
        <button id="processBtn" class="btn btn-primary">ğŸ¤– Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°ÙƒÙŠØ©</button>
        <button id="copyShortBtn" class="btn btn-success d-none">Ù†Ø³Ø® Ø§Ù„Ù‚ØµÙŠØ±Ø©</button>
        <button id="copyPrettyBtn" class="btn btn-info text-white d-none">Ù†Ø³Ø® Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©</button>
        <button id="downloadBtn" class="btn btn-warning d-none">XLSX</button>
      </div>
    </div>

    <div id="results" class="card p-3" style="display:none">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>#</th><th>Ø§Ù„Ø£ØµÙ„ÙŠ</th><th>Ø§Ù„Ù‚ØµÙŠØ±</th><th>Ø§Ù„Ø¬Ù…ÙŠÙ„</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://sherow1982.github.io/arabic-ads-calculator-tools/tools/modules/loader-backlink-nologin.js"></script>
  <script>
    // STATE
    let currentMode='short';
    let processed=[];

    // MODE SWITCH
    const tabShort=document.getElementById('tabShort');
    const tabPretty=document.getElementById('tabPretty');
    const tabBoth=document.getElementById('tabBoth');
    function setMode(m){
      currentMode=m;
      tabShort.className='btn btn-'+(m==='short'?'':'outline-')+'primary btn-sm';
      tabPretty.className='btn btn-'+(m==='pretty'?'':'outline-')+'primary btn-sm';
      tabBoth.className='btn btn-'+(m==='both'?'':'outline-')+'primary btn-sm';
    }
    tabShort.onclick = ()=>setMode('short');
    tabPretty.onclick= ()=>setMode('pretty');
    tabBoth.onclick  = ()=>setMode('both');

    // HELPERS
    function normalizeUrl(url){
      if(!url) return '';
      url=url.trim();
      if(!/^https?:\/\//.test(url)) url='https://'+url;
      try{
        const u=new URL(url);
        const path=u.pathname.replace(/\/\.\//g,'/').replace(/\/+/g,'/');
        return `${u.protocol}//${u.host}${path}${u.search}${u.hash}`;
      }catch{return url}
    }
    function slugifyFromUrl(url){
      try{
        const u=new URL(url); const q=new URLSearchParams(u.search);
        let t=q.get('name')||q.get('title')||q.get('q')||u.pathname.split('/').filter(Boolean).pop()||'item';
        t=decodeURIComponent(t).replace(/[\u0000-\u001F\u007F]/g,'').replace(/[^\u0600-\u06FFa-zA-Z0-9\s-]/g,'-').replace(/\s+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
        return t.substring(0,80)||'item';
      }catch{return 'item'}
    }
    function stats(){
      const lines=document.getElementById('urlInput').value.split('\n').filter(s=>s.trim());
      const seen=new Set();
      let v=0,inv=0,dup=0;
      lines.forEach(l=>{const n=normalizeUrl(l); if(seen.has(n)) dup++; else {seen.add(n); /^https?:\/\//.test(n)?v++:inv++;}});
      document.getElementById('totalCount').textContent=lines.length;
      document.getElementById('validCount').textContent=v;
      document.getElementById('duplicateCount').textContent=dup;
      document.getElementById('invalidCount').textContent=inv;
    }
    document.getElementById('urlInput').addEventListener('input',stats);

    // CLEAN
    function clean(){
      const ta=document.getElementById('urlInput');
      ta.value=ta.value.split('\n').map(s=>s.trim()).filter(Boolean).map(normalizeUrl).join('\n');
      stats();
    }
    document.getElementById('cleanBtn').onclick=clean;

    // PROCESS
    document.getElementById('processBtn').onclick=function(){
      const lines=document.getElementById('urlInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
      if(!lines.length){alert('Ø£Ø¯Ø®Ù„ Ø±ÙˆØ§Ø¨Ø·');return}
      const tbody=document.getElementById('tbody'); tbody.innerHTML=''; processed=[];
      const base='https://sherow1982.github.io/arabic-ads-calculator-tools';
      lines.forEach((l,i)=>{
        const n=normalizeUrl(l); const slug=slugifyFromUrl(n);
        const short=`${base}/s.html?to=${encodeURIComponent(n)}`;
        const showShort=(currentMode==='short'||currentMode==='both');
        const showPretty=(currentMode==='pretty'||currentMode==='both');
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td dir="ltr" style="font-family:monospace">${n}</td><td>${showShort?`<a href="${short}" target="_blank">${short}</a>`:'-'}</td><td>${showPretty?`${n}`:'-'}</td>`;
        tbody.appendChild(tr);
        processed.push({index:i+1,original:l,normalized:n,short:short,slug:slug,pretty:n});
      });
      document.getElementById('results').style.display='block';
      document.getElementById('copyShortBtn').classList.toggle('d-none',!(currentMode==='short'||currentMode==='both'));
      document.getElementById('copyPrettyBtn').classList.toggle('d-none',!(currentMode==='pretty'||currentMode==='both'));
      document.getElementById('downloadBtn').classList.remove('d-none');
    };

    // COPY & XLSX
    document.getElementById('copyShortBtn').onclick=function(){
      const list=processed.map(r=>r.short).join('\n'); navigator.clipboard.writeText(list);
    };
    document.getElementById('copyPrettyBtn').onclick=function(){
      const list=processed.map(r=>r.pretty).join('\n'); navigator.clipboard.writeText(list);
    };
    document.getElementById('downloadBtn').onclick=function(){
      const rows=processed.map(r=>({'#':r.index,'Ø§Ù„Ø£ØµÙ„ÙŠ':r.original,'Ø§Ù„Ù‚ØµÙŠØ±':r.short,'Ø§Ù„Ø¬Ù…ÙŠÙ„':r.pretty,'Slug':r.slug}));
      const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„Ù†ØªØ§Ø¦Ø¬'); XLSX.writeFile(wb,'smart-urls.xlsx');
    };

    // BACKLINK (NO-LOGIN)
    document.getElementById('backlinkBtn').onclick=function(){
      if(!processed.length){alert('Ù†ÙÙ‘Ø° Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆÙ„Ø§Ù‹');return}
      const url=processed[0].pretty; // Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† ÙƒÙ…Ø§ Ø·ÙÙ„Ø¨
      if(!window.BacklinkNoLogin){alert('ÙˆØ­Ø¯Ø© Ø§Ù„Ø¨Ø§Ùƒ Ù„ÙŠÙ†Ùƒ Ù„Ù… ØªÙØ­Ù…Ù‘Ù„ Ø¨Ø¹Ø¯. Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ø±Ø¨.');return}
      const opened=window.BacklinkNoLogin.run(url);
      const ws=XLSX.utils.json_to_sheet(opened.map((r,i)=>({'#':i+1,'Site':r.site,'URL':r.url,'Opened':r.ok?'Yes':'Popup blocked'})));
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Backlinks'); XLSX.writeFile(wb,'backlink-report.xlsx');
    };

    // INIT
    setMode('short'); stats();
  </script>
</body>
</html>